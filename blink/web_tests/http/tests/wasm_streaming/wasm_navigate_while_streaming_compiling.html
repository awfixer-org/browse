<!DOCTYPE html>
<script src="../../../resources/testharness.js"></script>
<script src="../../../resources/testharnessreport.js"></script>
<script>

promise_test(async test => {

  const url1 = 'resources/wasm_load.html?small.wasm';
  const url2 = 'resources/wasm_load.html?large.wasm';

  const popups = [];
  for (let i = 0; i < 5; ++i) {
    popups.push(window.open('about:blank'));
  }
  test.add_cleanup(() => {
    for (let popup of popups) popup.close();
  });

  const timeout = ms => new Promise(resolve => setTimeout(resolve, ms));

  for (let i = 0; i < 20; ++i) {
    let navigationPromiseResolve;
    const url = i % 2 ? url1 : url2;
    console.log(`[parent] Iteration ${i}, navigating popups to ${url}`);
    for (let popup of popups) popup.location.href = url;
    const ms = Math.floor(Math.random() * 50);
    console.log(`[parent] Waiting for ${ms}ms`);
    if (ms) await timeout(ms);
  }
  for (let popup of popups) popup.close();
}, "Test navigating away while Wasm streaming compilation is running");

</script>
