<!DOCTYPE html>
<link rel="stylesheet" href="/wpt_internal/resources/canvas-draw-element/styles.css" />
<script src="/wpt_internal/resources/canvas-draw-element/color-grid.js"></script>
<style>
 body {
   display: grid;
   grid: 256px / 1fr 1fr 1fr;
   align-items: start;
   --spread: 30px;
 }
 color-grid {
   width:100px;
   height:100px;
 }
 .box-shadow {
   box-shadow: 10px 20px 0px var(--spread) hotpink;
 }
 .outline {
   outline: 5px solid salmon;
 }
 .same-size-as-canvas {
   width: 256px;
   height: 256px;
 }
</style>

<div class="draw-element-wrapper" outset="50">
  <color-grid class="box-shadow"></color-grid>
</div>

<div class="draw-element-wrapper" outset="50">
  <color-grid class="outline"></color-grid>
</div>

<div class="draw-element-wrapper" outset="-20">
  <color-grid class="box-shadow"></color-grid>
</div>

<div class="draw-element-wrapper" outset="-20">
  <color-grid class="outline"></color-grid>
</div>

<div class="same-size-as-canvas"></div>

<script type="text/javascript">
// Theoretical client rect dimensions of the canvas.
var canvasCssWidth, canvasCssHeight;
</script>

<script type="module">
const sameSizeAsCanvas = document.querySelector(".same-size-as-canvas");
await new Promise(resolve => {
  new ResizeObserver(entries => {
    const style = getComputedStyle(sameSizeAsCanvas);
    canvasCssWidth = Number.parseFloat(style.width);
    canvasCssHeight = Number.parseFloat(style.height);
    resolve();
  }).observe(sameSizeAsCanvas);
});

Array.from(document.querySelectorAll(".draw-element-wrapper")).forEach(wrapper => {
  // Offset by visible ink overflow extent
  const outset = Number.parseFloat(wrapper.getAttribute("outset") || "0");
  wrapper.style.transform = `translate(${outset}px, ${outset}px)`;
  // Imitate clipping behavior of canvas
  wrapper.style.clipPath =
    `rect(${-outset}px ${canvasCssWidth-outset}px ${canvasCssHeight-outset}px ${-outset}px)`;

  const colorGrid = wrapper.firstElementChild;
  const colorGridStyle = getComputedStyle(colorGrid);
  const colorGridWidth = Number.parseFloat(colorGridStyle.width);
  const colorGridHeight = Number.parseFloat(colorGridStyle.height);
  const outsetRight = colorGridWidth + outset;
  const outsetBottom = colorGridHeight + outset;
  // Imitate (swidth|sheight) arguments to texElementImage2D
  colorGrid.style.clipPath = `rect(${-outset}px ${outsetRight}px ${outsetBottom}px ${-outset}px)`;
});
</script>
