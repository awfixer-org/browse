<!DOCTYPE html>
<html class="reftest-wait">
  <title>WebGPU copyElementImageToTexture with source rect</title>
  <meta charset="utf-8" />
  <link rel="help" href="https://github.com/WICG/html-in-canvas" />
  <link rel="match" href="copy_element_image_to_texture-source-rect-ref.html" />
  <link rel="stylesheet" href="/wpt_internal/resources/canvas-draw-element/styles.css" />
  <script src="/wpt_internal/resources/canvas-draw-element/color-grid.js"></script>
  <script src="/common/reftest-wait.js"></script>

  <style>
   body {
     display: grid;
     grid: 256px / 1fr 1fr 1fr;
     align-items: start;
   }
   canvas {
     width: 256px;
     height: 256px;
   }
   color-grid {
     width: 100px;
     height: 100px;
   }
   .box-shadow {
     box-shadow: 10px 20px 0px 30px hotpink;
   }
   .outline {
     outline: 5px solid salmon;
   }
  </style>

  <canvas layoutsubtree>
    <div class="draw-element-wrapper box-shadow" outset="50">
      <color-grid></color-grid>
    </div>
  </canvas>

  <canvas layoutsubtree>
    <div class="draw-element-wrapper outline" outset="50">
      <color-grid></color-grid>
    </div>
  </canvas>

  <canvas layoutsubtree>
    <div class="draw-element-wrapper box-shadow" outset="-20">
      <color-grid></color-grid>
    </div>
  </canvas>

  <canvas layoutsubtree>
    <div class="draw-element-wrapper outline" outset="-20">
      <color-grid></color-grid>
    </div>
  </canvas>

<script type="module">
console.log("Hello, world!");
import { resizeToPixelGrid, copyElementImageToWebGPUCanvas } from "/wpt_internal/resources/canvas-draw-element/util.js";

const adapter = await navigator.gpu.requestAdapter();
const device = await adapter.requestDevice();
const queue = device.queue;

Promise.all(Array.from(document.querySelectorAll("canvas")).map(async cvs => {
  await resizeToPixelGrid(cvs);
  const ctx = cvs.getContext("webgpu");
  ctx.configure({
    device: device,
    format: navigator.gpu.getPreferredCanvasFormat(),
    usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.RENDER_ATTACHMENT,
    alphaMode: "premultiplied",
  });
  const target = cvs.firstElementChild;
  let sx, sy, swidth, sheight;
  if (target.hasAttribute("outset")) {
    const outset = Number.parseFloat(target.getAttribute("outset"));
    const targetStyle = getComputedStyle(target);
    const targetWidth = Number.parseFloat(targetStyle.width);
    const targetHeight = Number.parseFloat(targetStyle.height);
    copyElementImageToWebGPUCanvas(
      queue, ctx, target, undefined, undefined,
      -outset, -outset, targetWidth + 2*outset, targetHeight + 2*outset);
  } else {
    const outset = Number.parseFloat(target.getAttribute("outset"));
    copyElementImageToWebGPUCanvas(queue, ctx, target);
  }
})).then(takeScreenshot);
</script>
</html>
